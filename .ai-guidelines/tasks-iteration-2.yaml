plan:
  project: "Telegram keyword monitor + forwarder (local Python CLI)"
  assumptions:
    - "Environment variables TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_SESSION_STRING are available."
    - "Runs on macOS with standard Python interpreter."
  tasks:
    - id: "task 1"
      title: "Plan destination chat pre-clean behavior"
      summary: "Define deletion flow, limits, and failure handling."
      description: >
        Determine how to delete all existing messages in the destination chat before any run processing.
        Clarify API usage, expected rate limits, and the exact abort behavior when deletion is not permitted.
      dependencies: []
      completed: false
      subtasks:
        - id: "task 1.1"
          title: "Define deletion strategy"
          summary: "Choose message iteration and deletion approach."
          description: >
            Decide how to enumerate and delete all destination messages, including handling large histories,
            rate limits, and any library constraints for batch deletions.
          dependencies: []
          completed: false
        - id: "task 1.2"
          title: "Define abort and logging rules"
          summary: "Specify failure behavior and error reporting."
          description: >
            Specify the exact error message and exit behavior when deletion is not permitted or fails,
            ensuring the run stops before any source processing or forwarding.
          dependencies: []
          completed: false

    - id: "task 2"
      title: "Implement destination chat pre-clean"
      summary: "Delete all messages before any run activity that touches destination chat."
      description: >
        Add a pre-clean step that deletes all existing messages in the destination chat before fetching
        or processing any sources, and before forwarding. If deletion fails, log a clear error and
        terminate the run.
      dependencies: ["task 1"]
      completed: false
      subtasks:
        - id: "task 2.1"
          title: "Add Telegram client deletion helper"
          summary: "Delete all destination messages with retries."
          description: >
            Implement a client helper that iterates messages in the destination chat and deletes them,
            respecting rate limits and returning success/failure for orchestration.
          dependencies: ["task 1.1"]
          completed: false
        - id: "task 2.2"
          title: "Integrate pre-clean into run orchestration"
          summary: "Run deletion first and abort on failure."
          description: >
            Ensure the pre-clean step is the first operation in any run that forwards messages.
            If deletion fails or is not permitted, log the error and stop without processing sources.
          dependencies: ["task 2.1", "task 1.2"]
          completed: false
        - id: "task 2.3"
          title: "Add structured logging for pre-clean"
          summary: "Log deletion start/end and failures."
          description: >
            Emit structured logs for deletion start, success, counts (if available), and failure details
            without leaking sensitive data.
          dependencies: ["task 2.1"]
          completed: false

    - id: "task 3"
      title: "Update tests and validation"
      summary: "Cover pre-clean behavior in tests and checklist."
      description: >
        Add or update tests for the run abort behavior when destination deletion fails and extend manual
        validation steps to include pre-clean verification.
      dependencies: ["task 2"]
      completed: false
      subtasks:
        - id: "task 3.1"
          title: "Test run abort on deletion failure"
          summary: "Verify run stops before source processing."
          description: >
            Add unit tests or integration-style tests that simulate a deletion failure and assert that
            no source processing or forwarding occurs.
          dependencies: ["task 2.2"]
          completed: false
        - id: "task 3.2"
          title: "Update manual validation checklist"
          summary: "Add pre-clean steps to validation."
          description: >
            Extend the validation checklist to confirm destination chat is cleared before run processing
            and that failures stop the run with a clear error.
          dependencies: ["task 2.2"]
          completed: false
