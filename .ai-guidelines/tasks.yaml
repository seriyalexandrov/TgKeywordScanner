plan:
  project: telegram_keyword_forwarder_cli
  goal: >
    Local macOS Python CLI that monitors multiple Telegram sources (chats/groups/channels/forum topics)
    for keyword matches and forwards matches to a single destination chat, persisting per-source cursors
    to process only new content (first run: last 24h only).

  tasks:
    - id: "task 1"
      completed: false
      name: "Architecture and library selection"
      summary: "Define the technical approach and core data model."
      description: >
        Decide the Telegram client library (e.g., Telethon or Pyrogram) based on user-account auth,
        forwarding/copy capabilities, and forum topic support. Produce a short architecture outline:
        modules, data flow (list-chats vs run), cursor strategy (message_id preferred, timestamp fallback),
        and failure-handling principles.
      depends_on: []
      children:
        - id: "task 2"
          completed: false
          name: "Define data model and cursor rules"
          summary: "Specify config schema and cursor semantics."
          description: >
            Define YAML schema for destination and sources (chat_id, optional topic_id, keywords),
            and tool-managed cursor fields (last_message_id, last_timestamp). Specify idempotency rules:
            a processed message must never be re-forwarded; cursor advances only after successful scan
            (and optionally after forward attempts, per chosen policy).
          depends_on: []
        - id: "task 3"
          completed: false
          name: "Define execution flow and error isolation"
          summary: "Specify how run mode processes sources safely."
          description: >
            Define per-source processing boundaries so one source failure does not stop others.
            Decide retry/backoff policy for rate limits and transient errors, and define what constitutes
            a fatal vs recoverable error.
          depends_on: []

    - id: "task 4"
      completed: false
      name: "Repository scaffolding and packaging"
      summary: "Create an installable Python CLI project."
      description: >
        Initialize repository structure, dependency management, and CLI entrypoint so the tool can be
        installed and executed via a single command. Keep dependencies minimal and macOS-friendly.
      depends_on: ["task 1"]
      children:
        - id: "task 5"
          completed: false
          name: "Project skeleton (pyproject, src layout, entrypoint)"
          summary: "Set up packaging and console script."
          description: >
            Create pyproject.toml, src/ package layout, and a console script entrypoint for the CLI.
            Pin minimal required dependencies (Telegram client lib, YAML parser, CLI framework, logging).
          depends_on: []
        - id: "task 6"
          completed: false
          name: "Dev tooling (lint/test hooks)"
          summary: "Add basic quality gates."
          description: >
            Add formatter/linter configuration and a test runner setup to ensure consistent code style
            and repeatable checks.
          depends_on: []

    - id: "task 7"
      completed: false
      name: "Configuration load/store with atomic cursor persistence"
      summary: "Implement YAML config handling and safe writes."
      description: >
        Load config from default path (~/.telegram-scrapper-config.yaml) or --config override, validate
        required fields, and persist tool-managed cursor updates using atomic write (temp file + rename).
        Ensure config is human-readable and machine-editable.
      depends_on: ["task 4"]
      children:
        - id: "task 8"
          completed: false
          name: "Config loader and schema validation"
          summary: "Parse YAML and validate required fields."
          description: >
            Implement YAML parsing, validate destination_chat_id, and validate each source has chat_id
            and a non-empty keywords list. Normalize keywords (e.g., dedupe) without changing semantics.
            Do not log secrets.
          depends_on: []
        - id: "task 9"
          completed: false
          name: "Cursor store and atomic writer"
          summary: "Persist per-source cursor updates safely."
          description: >
            Implement write-to-temp-then-rename persistence (NFR-1). Update only cursor fields managed
            by the tool. Ensure partial progress cannot corrupt the config; if a crash happens mid-run,
            the previous valid config remains intact.
          depends_on: []
        - id: "task 10"
          completed: false
          name: "Default file location and permissions"
          summary: "Use secure defaults under the home directory."
          description: >
            Resolve default config path under the user’s home directory. On creation, recommend/ensure
            restrictive permissions (e.g., user-only read/write) for config and session files (NFR-7).
          depends_on: []

    - id: "task 11"
      name: "Telegram authentication and session management"
      completed: false
      summary: "Support user-account login with local session storage."
      description: >
        Implement authentication via api_id/api_hash and a local session file so the tool can access
        the user’s dialogs. Ensure credentials/session are never printed in logs (NFR-6).
      depends_on: ["task 7"]
      children:
        - id: "task 12"
          name: "Session initialization and reuse"
          completed: false
          summary: "Create/reuse a local Telegram session."
          description: >
            Implement client startup that reuses an existing session if present, otherwise performs an
            interactive login (code/password if required). Store session under the home directory by default.
          depends_on: []
        - id: "task 13"
          name: "Safe logging guardrails for secrets"
          summary: "Prevent accidental credential/session leakage."
          description: >
            Add logging filters/redaction patterns and ensure exceptions do not dump sensitive values.
            Confirm CLI help and debug logs never echo api_hash/session payloads.
          depends_on: []

    - id: "task 14"
      name: "CLI framework and command wiring"
      completed: false
      summary: "Implement CLI with list-chats and run commands."
      description: >
        Provide a macOS-friendly CLI with subcommands: list-chats and run (FR-14), plus global flags
        like --config and --log-level. Ensure consistent exit codes and structured logs.
      depends_on: ["task 11"]
      children:
        - id: "task 15"
          completed: false
          name: "Global CLI options and config resolution"
          summary: "Wire --config and logging flags."
          description: >
            Implement default config path resolution and --config override. Add --log-level and ensure
            logs are structured and readable, with optional verbosity.
          depends_on: []
        - id: "task 16"
          completed: false
          name: "Command stubs and help text"
          summary: "Create list-chats and run command shells."
          description: >
            Implement CLI command registration, help/usage output, and argument validation before any
            Telegram calls are made.
          depends_on: []

    - id: "task 17"
      completed: false
      name: "list-chats implementation"
      summary: "Enumerate dialogs and provide IDs/types; assist with topic IDs."
      description: >
        Implement list-chats mode (FR-6): print dialog title, chat_id, and type. For forum-enabled
        supergroups, provide topic discovery where feasible or a practical way to resolve topic_id from
        recent messages/threads.
      depends_on: ["task 14"]
      children:
        - id: "task 18"
          completed: false
          name: "Dialog enumeration and type classification"
          summary: "List accessible chats/channels with metadata."
          description: >
            Fetch dialogs the account can see and classify as private/group/supergroup/channel.
            Print stable identifiers and human-friendly titles.
          depends_on: []
        - id: "task 19"
          completed: false
          name: "Forum topic discovery support"
          summary: "Expose topic IDs for forum-enabled groups."
          description: >
            Implement topic listing if supported by the chosen library; otherwise provide a best-effort
            method to derive topic_id from recent thread messages (e.g., inspecting thread identifiers).
            Clearly present what was found and how to use it in config.
          depends_on: []

    - id: "task 20"
      completed: false
      name: "Run mode: incremental monitoring pipeline"
      summary: "Fetch new messages per source, match keywords, forward, and persist cursors."
      description: >
        Implement run mode (FR-7..FR-15): iterate sources, fetch only new content (first run: last 24h),
        match keywords (case-insensitive substring), forward/copy to destination, and update per-source
        cursor atomically. Ensure per-source isolation and bounded memory usage.
      depends_on: ["task 14"]
      children:
        - id: "task 21"
          completed: false
          name: "Per-source fetch window and cursor logic"
          summary: "Compute message ranges to scan."
          description: >
            For first-time sources (no cursor): set lower bound to now-24h. Otherwise fetch since cursor
            (prefer message_id > last_message_id when available; timestamp fallback as defined in task 2).
            Support forum topics via (chat_id, topic_id) scoping.
          depends_on: []
        - id: "task 22"
          completed: false
          name: "Message retrieval and filtering"
          summary: "Retrieve messages efficiently and safely."
          description: >
            Fetch messages incrementally, avoiding full history scans (NFR-8). Ignore non-content/system
            events if needed. Handle messages with media but no text by checking captions; if no text/caption,
            skip matching (edge case requirement).
          depends_on: []
        - id: "task 23"
          completed: false
          name: "Keyword matching engine"
          summary: "Deterministic case-insensitive substring matching."
          description: >
            Implement matching per source: a message matches if any keyword is contained in message text
            or caption, case-insensitive, substring (FR-10). Ensure deterministic behavior and avoid duplicate
            matches within the same message due to repeated keywords.
          depends_on: []
        - id: "task 24"
          completed: false
          name: "Forwarding with fallback copy and restriction handling"
          summary: "Forward when possible, otherwise copy or log."
          description: >
            Attempt Telegram forward to destination (preserving original). If restricted (e.g., protected content),
            fall back to copying text and any supported media/caption if the library supports it; otherwise log a
            clear per-message error and continue (FR-12).
          depends_on: []
        - id: "task 25"
          completed: false
          name: "Cursor advancement and atomic persistence integration"
          summary: "Update cursors without breaking idempotency."
          description: >
            Advance cursor in a way that guarantees already-processed messages are never re-forwarded (FR-11).
            Persist cursor updates via the atomic writer from task 9. Ensure safe stop/re-run behavior (FR-15).
          depends_on: []
        - id: "task 26"
          completed: false
          name: "Per-source error isolation and bounded retries"
          summary: "Keep processing other sources when one fails."
          description: >
            Wrap each source processing in error boundaries. Implement bounded retries with backoff for rate limits
            and transient Telegram errors (NFR-2), and ensure failures don’t stop remaining sources (NFR-3).
          depends_on: []

    - id: "task 27"
      completed: false
      name: "Observability and operational logging"
      summary: "Structured logs with per-source metrics and configurable verbosity."
      description: >
        Implement logging required by NFR-10: start/end markers, per-source scanned/matched/forwarded counts,
        and errors with enough detail to debug. Support configurable log level via CLI/config.
      depends_on: ["task 20"]
      children:
        - id: "task 28"
          completed: false
          name: "Structured log format and counters"
          summary: "Standardize log events and metrics."
          description: >
            Implement consistent log fields (command, source identifier, counts, timings, error codes/messages).
            Ensure logs avoid sensitive content (credentials/session).
          depends_on: []
        - id: "task 29"
          completed: false
          name: "User-facing summaries per run"
          summary: "Provide concise end-of-run reporting."
          description: >
            Emit an end-of-run summary aggregating per-source results and listing sources with failures,
            without stopping the run prematurely.
          depends_on: []

    - id: "task 30"
      completed: false
      name: "Security and privacy hardening"
      summary: "Ensure local artifacts are safe by default."
      description: >
        Verify config/session storage locations under home directory, apply restrictive permissions guidance,
        and ensure logs never print secrets. Confirm behavior on shared machines is clearly safe by default.
      depends_on: ["task 27"]
      children:
        - id: "task 31"
          completed: false
          name: "File permission enforcement and checks"
          summary: "Harden config/session file permissions."
          description: >
            On write/create, enforce or warn if permissions are too open. Keep behavior macOS-compatible and
            avoid breaking existing valid setups.
          depends_on: []
        - id: "task 32"
          completed: false
          name: "Sensitive data handling review"
          summary: "Audit code paths for secret leakage."
          description: >
            Review exception paths, debug logs, and config dumps to ensure api_hash, session content, and other
            sensitive data are not emitted.
          depends_on: []

    - id: "task 33"
      completed: false
      name: "Testing and validation"
      summary: "Prove correctness for cursors, matching, forwarding behavior, and resilience."
      description: >
        Add unit tests for config parsing, cursor updates, atomic write behavior, and keyword matching.
        Add integration-style tests using mocks/stubs for Telegram API calls, and a manual test checklist
        for real accounts/chats.
      depends_on: ["task 30"]
      children:
        - id: "task 34"
          completed: false
          name: "Unit tests for config/cursor/matching"
          summary: "Cover deterministic logic with fast tests."
          description: >
            Test YAML load/validate, cursor read/write (including crash-safe atomic replace semantics),
            first-run 24h window computation, and case-insensitive substring matching across text/caption.
          depends_on: []
        - id: "task 35"
          completed: false
          name: "Mocked integration tests for run pipeline"
          summary: "Validate orchestration without hitting Telegram."
          description: >
            Mock client calls to simulate message streams, rate limits, forwarding failures/restrictions,
            and ensure per-source isolation and cursor advancement rules hold.
          depends_on: []
        - id: "task 36"
          completed: false
          name: "Manual test checklist"
          summary: "Validate on real chats/groups/channels/topics."
          description: >
            Step-by-step checklist to verify list-chats output, topic_id resolution, first-run 24h behavior,
            incremental runs, protected content handling, and safe re-run after interruption.
          depends_on: []

    - id: "task 37"
      completed: false
      name: "Documentation and deliverable packaging"
      summary: "Provide clear install, config, and usage documentation."
      description: >
        Write README with installation, authentication notes, config example, list-chats usage, run usage,
        logging options, and troubleshooting guidance. Ensure a single install/run path and produce a minimal
        release artifact.
      depends_on: ["task 33"]
      children:
        - id: "task 38"
          completed: false
          name: "README and example config"
          summary: "Document setup and configuration."
          description: >
            Provide a sample YAML config including destination, sources, keywords, and tool-managed cursor fields
            (clearly marked as managed). Document default config path and --config override.
          depends_on: []
        - id: "task 39"
          completed: false
          name: "Operational notes and troubleshooting"
          summary: "Document common failures and how logs explain them."
          description: >
            Document rate limit behavior, forwarding restrictions, missing permissions, and topic_id discovery
            limitations, with guidance on interpreting per-source logs and counters.
          depends_on: []