plan:
  project: "Telegram keyword monitor + forwarder (local Python CLI)"
  assumptions:
    - "Environment variables TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_SESSION_STRING are available."
    - "Runs on macOS with standard Python interpreter."
  tasks:
    - id: "task 1"
      title: "Define architecture and library choices"
      summary: "Choose Telegram client library, data model, and CLI structure."
      description: >
        Decide on the Telegram client library (e.g., Telethon) that supports user sessions, message iteration,
        forwarding/copy fallbacks, and forum topic handling. Define core modules (config, storage, telegram client,
        matcher, forwarder, logging, CLI) and overall execution flow for list-chats and run modes.
      dependencies: []
      completed: false
      subtasks:
        - id: "task 1.1"
          title: "Select Telegram client library and capabilities"
          summary: "Confirm feature support for dialogs, topics, incremental fetch, forwarding."
          description: >
            Validate that the chosen library supports: enumerating dialogs, retrieving chat types, reading messages
            incrementally via IDs/timestamps, filtering by thread/topic_id, forwarding messages, and (if possible)
            copying media/text when forwarding is restricted. Document limitations and fallback behaviors.
          dependencies: []
          completed: false
        - id: "task 1.2"
          title: "Define internal data model"
          summary: "Establish config schema, cursor schema, and runtime counters."
          description: >
            Specify YAML configuration structure: destination_chat_id, sources list with chat_id/topic_id/keywords,
            and tool-managed cursor fields (last_message_id, last_timestamp). Define in-memory representations
            including per-source keys (chat_id, topic_id) and per-run stats (scanned, matched, forwarded, errors).
          dependencies: []
          completed: false

    - id: "task 2"
      title: "Set up project skeleton and packaging"
      summary: "Create repository layout, dependency management, and entry points."
      description: >
        Create a Python package layout with clear modules and a CLI entry point. Add dependency declarations,
        minimal README/run instructions, and ensure compatibility with macOS Python environments.
      dependencies: ["task 1"]
      completed: false
      subtasks:
        - id: "task 2.1"
          title: "Create module structure"
          summary: "Lay out code into cohesive modules."
          description: >
            Create modules such as: cli.py, telegram_client.py, config.py, storage.py, matcher.py, forwarder.py,
            logging_setup.py, and utils.py. Ensure imports and boundaries support testing and maintainability.
          dependencies: ["task 1"]
          completed: false
        - id: "task 2.2"
          title: "Define dependencies and lock strategy"
          summary: "Pin required packages."
          description: >
            Add requirements with pinned versions for Telegram client library, YAML parser, CLI framework
            (argparse/click/typer), and structured logging. Ensure installation works in a fresh venv on macOS.
          dependencies: ["task 1"]
          completed: false

    - id: "task 3"
      title: "Implement configuration loading and validation"
      summary: "Load YAML config from default path or CLI override and validate contents."
      description: >
        Implement reading from ~/.telegram-scrapper-config.yaml by default and from --config when provided.
        Validate that destination_chat_id exists, sources contain required fields, keywords list is non-empty,
        and reject/repair malformed cursor fields without exposing sensitive data.
      dependencies: ["task 2"]
      completed: false
      subtasks:
        - id: "task 3.1"
          title: "Implement YAML config loader"
          summary: "Read YAML from disk with default and override path."
          description: >
            Resolve default config path under the user home directory on macOS. Implement --config path override.
            Provide clear errors for missing/unreadable/invalid YAML files.
          dependencies: ["task 2"]
          completed: false
        - id: "task 3.2"
          title: "Implement config schema validation"
          summary: "Validate required fields and normalize inputs."
          description: >
            Validate destination_chat_id and each source's chat_id and keywords. Normalize keyword lists
            (trim whitespace, drop empty, de-duplicate). Validate optional topic_id as integer when present.
            Preserve tool-managed cursor fields if present; ignore unexpected fields safely.
          dependencies: ["task 3.1"]
          completed: false
        - id: "task 3.3"
          title: "Enforce safe default permissions guidance"
          summary: "Ensure config path expectations and recommend restrictive permissions."
          description: >
            Ensure the config is stored under the user's home directory by default. Implement warnings (not secrets)
            when permissions are overly permissive, and avoid printing credentials/session values.
          dependencies: ["task 3.1"]
          completed: false

    - id: "task 4"
      title: "Implement atomic storage for cursor persistence"
      summary: "Persist updated cursor back into YAML safely and atomically."
      description: >
        Implement reading/writing YAML with atomic updates (write temp file then rename). Ensure cursor writes
        do not corrupt state on interruption, and updates are per-source keyed by (chat_id, topic_id).
      dependencies: ["task 3"]
      completed: false
      subtasks:
        - id: "task 4.1"
          title: "Implement source keying for cursor updates"
          summary: "Define unique identity for each monitored stream."
          description: >
            Implement a stable key for cursor mapping based on chat_id and optional topic_id. Ensure that
            sources with same chat_id but different topic_id keep separate cursors, and duplicates are detected.
          dependencies: ["task 3"]
          completed: false
        - id: "task 4.2"
          title: "Implement atomic YAML write"
          summary: "Write-to-temp then rename."
          description: >
            Implement safe persistence: serialize updated config to a temporary file in the same directory,
            fsync if needed, then atomic rename to the target path. Ensure partial progress cannot leave a
            corrupted YAML.
          dependencies: ["task 4.1"]
          completed: false
        - id: "task 4.3"
          title: "Implement cursor update strategy"
          summary: "Update cursor only after processing messages."
          description: >
            Update last_message_id (preferred) and/or last_timestamp after successfully scanning messages.
            Ensure idempotency: store the maximum processed position and never move cursor backwards.
            Avoid updating cursor when no messages were fetched.
          dependencies: ["task 4.2"]
          completed: false

    - id: "task 5"
      title: "Implement Telegram authentication and client wrapper"
      summary: "Create Telegram client using session string and provide safe API helpers."
      description: >
        Build a Telegram client wrapper that authenticates with TELEGRAM_API_ID, TELEGRAM_API_HASH,
        TELEGRAM_SESSION_STRING, and exposes helper methods for listing dialogs, listing topics where feasible,
        fetching messages incrementally, and forwarding/copying messages.
      dependencies: ["task 2", "task 3"]
      completed: false
      subtasks:
        - id: "task 5.1"
          title: "Implement session-based login"
          summary: "Authenticate without interactive prompts."
          description: >
            Initialize the Telegram client using the session string environment variable and validate
            connectivity. Ensure logs never print API ID/hash/session string.
          dependencies: ["task 2", "task 3"]
          completed: false
        - id: "task 5.2"
          title: "Implement rate limit handling primitives"
          summary: "Backoff and bounded retries."
          description: >
            Wrap Telegram API calls with retry logic for rate limits and transient failures. Implement
            exponential backoff with jitter and a maximum number of retries. Ensure errors surface with
            context but without secrets.
          dependencies: ["task 5.1"]
          completed: false
        - id: "task 5.3"
          title: "Implement per-source error isolation"
          summary: "Failures in one source do not block others."
          description: >
            Structure client calls so exceptions are caught per-source during run mode. Aggregate errors
            for reporting while continuing processing other sources.
          dependencies: ["task 5.2"]
          completed: false

    - id: "task 6"
      title: "Implement list-chats CLI mode"
      summary: "Enumerate dialogs, print IDs/types, and assist with topic ID discovery."
      description: >
        Implement list-chats command to print chat title, chat_id, and type. For forum-enabled supergroups,
        attempt to enumerate topics where feasible; otherwise provide a deterministic way to resolve topic IDs
        from recent messages/threads within that supergroup.
      dependencies: ["task 5"]
      completed: false
      subtasks:
        - id: "task 6.1"
          title: "Enumerate dialogs and chat metadata"
          summary: "Print title, id, and chat type."
          description: >
            Iterate dialogs available to the authenticated user and print: title, chat_id, and type
            (private/group/supergroup/channel). Ensure output is stable and script-friendly.
          dependencies: ["task 5"]
          completed: false
        - id: "task 6.2"
          title: "Forum topic discovery support"
          summary: "List topics or provide topic_id resolution method."
          description: >
            For forum-enabled supergroups, attempt to retrieve and display topic titles and topic_id values.
            If direct enumeration is not supported by the library/API, implement a mode that inspects recent
            messages and prints observed topic/thread identifiers to help configure sources.
          dependencies: ["task 6.1"]
          completed: false

    - id: "task 7"
      title: "Implement incremental message retrieval per source"
      summary: "Fetch only last 24h on first track, otherwise since cursor."
      description: >
        Implement run-mode fetching for each source. If no cursor exists, retrieve messages from the last
        24 hours only. Otherwise fetch messages newer than last cursor (message_id and/or timestamp).
        Support chats, channels, supergroups, and forum topics via topic_id where applicable.
      dependencies: ["task 4", "task 5"]
      completed: false
      subtasks:
        - id: "task 7.1"
          title: "Compute fetch window from cursor"
          summary: "Decide start point based on stored cursor or 24h default."
          description: >
            If cursor missing: compute since_timestamp = now - 24 hours. If cursor present: use last_message_id
            when available; otherwise use last_timestamp. Ensure boundaries avoid re-processing already handled
            messages.
          dependencies: ["task 4", "task 5"]
          completed: false
        - id: "task 7.2"
          title: "Fetch messages for chat/channel/supergroup"
          summary: "Iterate messages incrementally without full history scans."
          description: >
            Implement message iteration that yields messages newer than the computed window. Keep memory usage
            low by streaming messages rather than loading all into memory.
          dependencies: ["task 7.1"]
          completed: false
        - id: "task 7.3"
          title: "Fetch messages for forum topics"
          summary: "Restrict retrieval to a specific topic/thread."
          description: >
            When topic_id is configured, fetch only messages belonging to that topic/thread. Ensure cursor is
            tracked per (chat_id, topic_id) and message iteration respects that scope.
          dependencies: ["task 7.1"]
          completed: false

    - id: "task 8"
      title: "Implement keyword matching"
      summary: "Deterministic case-insensitive substring match over text/captions."
      description: >
        Implement matching rules: case-insensitive substring search; a message matches if any keyword appears
        in message text or media caption. Skip messages with no text and no caption. Ensure deterministic
        behavior for idempotency.
      dependencies: ["task 7"]
      completed: false
      subtasks:
        - id: "task 8.1"
          title: "Normalize keywords per source"
          summary: "Prepare keyword set for efficient matching."
          description: >
            Convert keywords to a normalized form (e.g., lowercase) and de-duplicate. Preserve original strings
            only for reporting if needed.
          dependencies: ["task 3.2"]
          completed: false
        - id: "task 8.2"
          title: "Implement match function for message content"
          summary: "Scan text and caption fields."
          description: >
            Extract relevant fields from each message: text and caption. Perform case-insensitive substring
            checks against normalized keywords. Return match boolean and optionally which keyword matched.
          dependencies: ["task 8.1", "task 7"]
          completed: false

    - id: "task 9"
      title: "Implement forwarding with fallback behavior"
      summary: "Forward matching messages to destination; copy or log on restriction."
      description: >
        For each match, attempt a Telegram forward to the destination chat. If forwarding fails due to
        Telegram restrictions (e.g., protected content), attempt a best-effort copy of text and media/caption
        if supported. Otherwise log a clear per-message error and continue.
      dependencies: ["task 5", "task 8"]
      completed: false
      subtasks:
        - id: "task 9.1"
          title: "Implement forward attempt"
          summary: "Prefer native forward."
          description: >
            Use the library's forward mechanism to preserve original message/media where allowed.
            Capture and classify failures that suggest forwarding restrictions.
          dependencies: ["task 5"]
          completed: false
        - id: "task 9.2"
          title: "Implement copy fallback"
          summary: "Copy content when forwarding is blocked."
          description: >
            If forwarding fails, attempt to send copied content: text and available media/caption where the
            library supports re-sending. If media cannot be copied, send a text-only fallback if appropriate
            and log what was not transferable.
          dependencies: ["task 9.1"]
          completed: false
        - id: "task 9.3"
          title: "Ensure idempotent forwarding per cursor"
          summary: "Never forward already-processed messages."
          description: >
            Ensure the processing loop advances cursor only after handling each message in order, and that
            subsequent runs never re-process messages at or below the stored cursor position. Avoid duplicates
            even with overlapping sources by relying on per-source cursor logic.
          dependencies: ["task 7", "task 9.1", "task 9.2", "task 4.3"]
          completed: false

    - id: "task 10"
      title: "Implement run mode orchestration"
      summary: "Process all sources, isolate errors, update cursors atomically."
      description: >
        Implement the run command to iterate configured sources, fetch incremental messages, match keywords,
        forward matches to destination, collect per-source stats, and persist cursor updates atomically at the
        end (or per-source safely) without corrupting state.
      dependencies: ["task 7", "task 8", "task 9", "task 4"]
      completed: false
      subtasks:
        - id: "task 10.1"
          title: "Per-source processing loop"
          summary: "Fetch -> match -> forward -> cursor update."
          description: >
            For each source: compute fetch window, stream messages, apply matching, forward/copy as needed,
            track counts, and compute the updated cursor position. Ensure exceptions are caught per-source.
          dependencies: ["task 7", "task 8", "task 9", "task 5.3"]
          completed: false
        - id: "task 10.2"
          title: "Atomic cursor persistence integration"
          summary: "Persist updates safely after processing."
          description: >
            Update the in-memory config cursor fields per source and write back using atomic storage.
            Ensure that partial runs do not leave the config corrupted and do not regress cursor values.
          dependencies: ["task 10.1", "task 4.2", "task 4.3"]
          completed: false

    - id: "task 11"
      title: "Implement CLI interface and commands"
      summary: "Provide list-chats and run commands with config and logging options."
      description: >
        Build a CLI with at least two commands: list-chats and run. Support --config override. Implement log
        level configuration and ensure consistent exit codes for success vs fatal failures.
      dependencies: ["task 6", "task 10"]
      completed: false
      subtasks:
        - id: "task 11.1"
          title: "Implement CLI argument parsing"
          summary: "Commands, options, and defaults."
          description: >
            Implement parsing for commands: list-chats and run. Add global options: --config and --log-level.
            Ensure help text is available and accurate.
          dependencies: ["task 6", "task 10"]
          completed: false
        - id: "task 11.2"
          title: "Wire commands to implementations"
          summary: "Connect CLI to core modules."
          description: >
            Connect list-chats to dialog/topic enumeration and run to the orchestrator. Ensure proper
            initialization of logging and Telegram client per command.
          dependencies: ["task 11.1"]
          completed: false

    - id: "task 12"
      title: "Implement structured logging and observability"
      summary: "Add configurable structured logs and per-source metrics."
      description: >
        Implement structured logging that includes start/end markers, per-source counts (scanned/matched/forwarded),
        and detailed errors. Ensure secrets are not logged. Support configurable log level.
      dependencies: ["task 11"]
      completed: false
      subtasks:
        - id: "task 12.1"
          title: "Logging setup module"
          summary: "Structured logs with levels."
          description: >
            Implement logging configuration with a structured format (e.g., JSON lines or key-value format).
            Ensure log level can be set via CLI and defaults are reasonable.
          dependencies: ["task 11"]
          completed: false
        - id: "task 12.2"
          title: "Per-source summary logging"
          summary: "Emit counts and errors for each source."
          description: >
            Log per-source metrics: scanned, matched, forwarded, and any failures with enough context to debug
            (chat_id/topic_id/message_id) without leaking sensitive data.
          dependencies: ["task 10", "task 12.1"]
          completed: false

    - id: "task 13"
      title: "Harden reliability and edge case handling"
      summary: "Cover rate limits, empty sources, restricted forwards, and media-only messages."
      description: >
        Ensure correct behavior for: media-only messages (scan captions), sources with no messages, forwarding
        restrictions, and stopping/restarting safely. Confirm that only new messages are processed (not edits).
      dependencies: ["task 10", "task 12", "task 5.2"]
      completed: false
      subtasks:
        - id: "task 13.1"
          title: "Handle empty/no-recent-message sources"
          summary: "No-op cleanly without cursor changes."
          description: >
            Ensure run mode handles sources where the fetch returns zero messages. Do not update cursor and do
            not treat as error; log a clean summary.
          dependencies: ["task 10"]
          completed: false
        - id: "task 13.2"
          title: "Handle media-only messages"
          summary: "Scan captions; skip if no caption."
          description: >
            Ensure messages with no text but with media are evaluated via caption. If neither text nor caption
            exists, skip without error and count as scanned.
          dependencies: ["task 8.2", "task 10"]
          completed: false
        - id: "task 13.3"
          title: "Confirm edited message policy"
          summary: "Ignore edits by default."
          description: >
            Ensure the processing loop is based on new message arrival order and does not attempt to detect or
            re-process edited messages. Document the behavior clearly in logs or documentation.
          dependencies: ["task 10"]
          completed: false
        - id: "task 13.4"
          title: "Verify forward restriction fallbacks"
          summary: "Log and continue on failures."
          description: >
            Ensure that forwarding failures do not terminate the run. Validate that copy fallback is attempted
            when applicable and that clear per-message errors are logged otherwise.
          dependencies: ["task 9", "task 12.2"]
          completed: false

    - id: "task 14"
      title: "Create macOS runner shell script"
      summary: "Single script to create venv, install deps, run tool, and deactivate."
      description: >
        Implement a sh runner that creates/uses a local virtual environment, installs dependencies if needed,
        runs the CLI, and exits cleanly without requiring the user to manage Python setup manually.
      dependencies: ["task 11"]
      completed: false
      subtasks:
        - id: "task 14.1"
          title: "Implement venv bootstrap and dependency install"
          summary: "Automate environment setup."
          description: >
            Create a script that checks for a venv directory, creates it if missing, installs requirements,
            then executes the CLI with passed arguments. Ensure it uses the system python3 and works on macOS.
          dependencies: ["task 11"]
          completed: false
        - id: "task 14.2"
          title: "Ensure safe output and exit codes"
          summary: "Do not leak secrets; propagate errors."
          description: >
            Ensure the runner does not echo environment variables or session values. Propagate program exit codes
            so automation and CI can detect failures.
          dependencies: ["task 14.1", "task 12"]
          completed: false

    - id: "task 15"
      title: "Add tests and validation checklist"
      summary: "Verify correctness, idempotency, and edge cases."
      description: >
        Implement focused tests for keyword matching, cursor progression, atomic write behavior, and config
        validation. Provide a manual validation checklist for Telegram interactions (dialogs/topics/forwarding).
      dependencies: ["task 4", "task 8", "task 9", "task 10", "task 14"]
      completed: false
      subtasks:
        - id: "task 15.1"
          title: "Unit tests for matcher and config normalization"
          summary: "Validate case-insensitive substring behavior."
          description: >
            Add tests for keyword normalization and deterministic matching across text/caption fields, including
            duplicates and empty strings handling.
          dependencies: ["task 8", "task 3.2"]
          completed: false
        - id: "task 15.2"
          title: "Unit tests for cursor and atomic writes"
          summary: "Validate idempotency and crash-safety."
          description: >
            Add tests that ensure cursor does not regress, does not reprocess messages, and that atomic write
            strategy preserves valid YAML on simulated interruption scenarios.
          dependencies: ["task 4"]
          completed: false
        - id: "task 15.3"
          title: "Manual validation checklist for Telegram behaviors"
          summary: "Validate list-chats, topic handling, forwarding fallback."
          description: >
            Provide a checklist to validate on a real account: list-chats output, topic_id resolution, first-run
            24h behavior, incremental runs, restricted forward handling, and per-source error isolation.
          dependencies: ["task 6", "task 10", "task 9", "task 12"]
          completed: false