plan:
  title: "Telegram keyword monitor + forwarder (local Python CLI, macOS)"
  assumptions:
    - "Environment variables TELEGRAM_API_ID and TELEGRAM_API_HASH are available at runtime."
    - "Runs locally on macOS with a standard Python interpreter."
  tasks:
    - id: "task 1"
      summary: "Define architecture and library choices"
      description: >
        Finalize the technical approach: choose the Telegram client library (e.g., Telethon),
        define data models (Source, Cursor, Config), and outline how topics/threads will be represented
        and filtered during message retrieval. Produce a short internal design note mapping each FR/NFR
        to a module/function responsibility.
      dependencies: []
      completed: false
      subtasks:
        - id: "task 2"
          summary: "Select Telegram client library and confirm feature coverage"
          description: >
            Evaluate and pick a Python Telegram client that supports user sessions, reading dialogs,
            iterating messages incrementally, forwarding messages, and (when possible) copying content.
            Verify how forum topic/thread identifiers are exposed in message objects and how to filter by topic_id.
          dependencies: ["task 1"]
          completed: false
        - id: "task 3"
          summary: "Define module structure and responsibilities"
          description: >
            Create a package/module layout (cli, config, storage, telegram_client, matcher, processor, logging)
            and define clear boundaries: config load/save, cursor atomic persistence, rate-limit handling,
            per-source isolation, and forwarding fallback behavior.
          dependencies: ["task 2"]
          completed: false

    - id: "task 4"
      summary: "Project scaffolding and packaging"
      description: >
        Create a Python project structure that can be installed and run as a CLI entrypoint.
        Include pinned/minimum dependency versions, a lock strategy (optional), and basic developer tooling.
      dependencies: ["task 3"]
      completed: false
      subtasks:
        - id: "task 5"
          summary: "Create repository layout and Python package"
          description: >
            Initialize the package directory (e.g., telegram_scrapper/), add __init__.py,
            and create placeholders for each module. Add a pyproject.toml (or setup.cfg)
            defining dependencies and an entrypoint command.
          dependencies: ["task 4"]
          completed: false
        - id: "task 6"
          summary: "Add dependency set and runtime constraints"
          description: >
            Add dependencies for Telegram client, YAML parsing, and structured logging.
            Define supported Python versions and keep dependencies minimal to satisfy NFR-5.
          dependencies: ["task 5"]
          completed: false

    - id: "task 7"
      summary: "Configuration schema and YAML I/O"
      description: >
        Implement loading, validation, and saving of the YAML configuration file with the required
        fields (destination, sources, keywords, optional topic_id) and tool-managed cursor fields.
      dependencies: ["task 6"]
      completed: false
      subtasks:
        - id: "task 8"
          summary: "Define config schema and defaults"
          description: >
            Specify the YAML structure: destination_chat_id, sources[] with chat_id, optional topic_id,
            keywords[], and cursor fields (last_message_id, last_timestamp). Define default config path
            ~/.telegram-scrapper-config.yaml and allow override via --config.
          dependencies: ["task 7"]
          completed: false
        - id: "task 9"
          summary: "Implement config loader + validator"
          description: >
            Load YAML from disk, validate required fields and types, normalize duplicates in keywords,
            and ensure no secrets are logged. On missing file, provide a clear error with expected format.
          dependencies: ["task 8"]
          completed: false
        - id: "task 10"
          summary: "Implement atomic config persistence for cursor updates"
          description: >
            Save updated cursor fields back into the same YAML file using atomic write
            (write to temp file in same directory, fsync if practical, then rename).
          dependencies: ["task 9"]
          completed: false

    - id: "task 11"
      summary: "Local session authentication and storage"
      description: >
        Implement Telegram authentication using TELEGRAM_API_ID/TELEGRAM_API_HASH and a local session file
        stored under the user’s home directory by default, without printing credentials or session data.
      dependencies: ["task 10"]
      completed: false
      subtasks:
        - id: "task 12"
          summary: "Implement session file location and permissions"
          description: >
            Store the Telegram session under a deterministic home-directory path (e.g., ~/.telegram-scrapper-session)
            and recommend restrictive file permissions (e.g., chmod 600 where applicable). Ensure paths are configurable
            only if needed, otherwise keep defaults.
          dependencies: ["task 11"]
          completed: false
        - id: "task 13"
          summary: "Implement login flow and connectivity checks"
          description: >
            Create a Telegram client wrapper that initializes the session, prompts for login if needed
            (interactive terminal), and performs a minimal connectivity check before executing commands.
          dependencies: ["task 12"]
          completed: false

    - id: "task 14"
      summary: "CLI interface with commands and options"
      description: >
        Build the command-line interface supporting list-chats and run modes, config path override,
        and configurable log level. Ensure the CLI is stable for repeated use (FR-14).
      dependencies: ["task 13"]
      completed: false
      subtasks:
        - id: "task 15"
          summary: "Implement CLI parsing and global options"
          description: >
            Implement argument parsing for: subcommands (list-chats, run), --config path override,
            and --log-level. Validate arguments early and provide concise help text.
          dependencies: ["task 14"]
          completed: false
        - id: "task 16"
          summary: "Wire CLI to application services"
          description: >
            Connect CLI commands to config loader, Telegram client wrapper, and processing pipeline,
            ensuring clean exit codes and no leaking of sensitive information.
          dependencies: ["task 15"]
          completed: false

    - id: "task 17"
      summary: "list-chats implementation (dialogs and topic resolution)"
      description: >
        Implement enumeration of dialogs visible to the authenticated account and print title, chat_id,
        and chat type; for forum-enabled supergroups, provide topic_id information where feasible or a
        practical method to derive topic IDs from recent messages (FR-6).
      dependencies: ["task 16"]
      completed: false
      subtasks:
        - id: "task 18"
          summary: "Enumerate dialogs and print IDs + types"
          description: >
            Fetch all dialogs, determine whether each is private/group/supergroup/channel,
            and print a readable list with title, chat_id, and type. Keep output stable for scripting.
          dependencies: ["task 17"]
          completed: false
        - id: "task 19"
          summary: "Support forum topic discovery guidance"
          description: >
            For forum-enabled supergroups: attempt to list topics if the library supports it.
            If not available, provide a way to resolve topic_id from recent messages (e.g., show recent messages
            with their thread/topic identifiers when present) so the user can populate topic_id in config.
          dependencies: ["task 18"]
          completed: false

    - id: "task 20"
      summary: "Message retrieval strategy (incremental + first-run 24h window)"
      description: >
        Implement per-source message fetching that only processes new content:
        first time tracked => last 24 hours; otherwise => since stored cursor. Ensure it works across
        private chats, groups, supergroups, channels, and forum topics (FR-7, FR-8, NFR-8).
      dependencies: ["task 19"]
      completed: false
      subtasks:
        - id: "task 21"
          summary: "Implement cursor model and source keying"
          description: >
            Define cursor fields (last_message_id preferred, last_timestamp fallback) and ensure forum topics
            are uniquely keyed by (chat_id, topic_id). Ensure absent cursor is treated as first-run.
          dependencies: ["task 20"]
          completed: false
        - id: "task 22"
          summary: "Implement incremental fetch by message id/timestamp"
          description: >
            For each source: if last_message_id exists, fetch messages with id > last_message_id; otherwise,
            fetch messages newer than last_timestamp; for first-run, set the lower bound to now-24h.
            Ensure results are processed in ascending order for deterministic cursor advancement.
          dependencies: ["task 21"]
          completed: false
        - id: "task 23"
          summary: "Implement forum topic filtering"
          description: >
            When topic_id is configured, filter fetched messages to only those belonging to that topic/thread
            using the library’s exposed thread/topic identifiers. Ensure messages from other topics are ignored.
          dependencies: ["task 22"]
          completed: false

    - id: "task 24"
      summary: "Keyword matching (case-insensitive substring, deterministic)"
      description: >
        Implement matching for each source: a message matches if any configured keyword appears as a
        case-insensitive substring in message text or caption. Ensure deterministic behavior and that
        processed messages are not re-forwarded due to cursor logic (FR-10, FR-11).
      dependencies: ["task 23"]
      completed: false
      subtasks:
        - id: "task 25"
          summary: "Extract message text fields for scanning"
          description: >
            Implement extraction of relevant fields: message text and media caption. If neither exists,
            skip matching for that message (edge case support).
          dependencies: ["task 24"]
          completed: false
        - id: "task 26"
          summary: "Implement matcher with normalization"
          description: >
            Lowercase both haystack and keywords; de-duplicate keywords; implement substring checks.
            Keep matching idempotent by ensuring each message is evaluated once per run and cursor advances
            only after processing.
          dependencies: ["task 25"]
          completed: false

    - id: "task 27"
      summary: "Forwarding to destination with fallback-to-copy"
      description: >
        Implement forwarding of matched messages to the single destination chat.
        Prefer Telegram forward (preserving original), and fall back to copying content when forwarding is blocked;
        otherwise log a clear per-message error and continue (FR-12, FR-13).
      dependencies: ["task 26"]
      completed: false
      subtasks:
        - id: "task 28"
          summary: "Implement forward operation"
          description: >
            Use Telegram API/library to forward the original message to the destination chat when permitted.
            Preserve media and attribution as a forward.
          dependencies: ["task 27"]
          completed: false
        - id: "task 29"
          summary: "Implement copy fallback or error reporting"
          description: >
            If forward fails due to restrictions (e.g., protected content), attempt a best-effort copy:
            send text and available media/caption if supported by the library. If not supported or copy fails,
            log an actionable error including source, message id, and reason, then continue.
          dependencies: ["task 28"]
          completed: false

    - id: "task 30"
      summary: "Run pipeline: per-source processing, isolation, and cursor updates"
      description: >
        Implement the run command processing loop across all configured sources:
        fetch incrementally, match, forward, and persist updated cursors. Failures in one source must not block others,
        and cursor writes must be safe and atomic (FR-15, NFR-1, NFR-3).
      dependencies: ["task 29"]
      completed: false
      subtasks:
        - id: "task 31"
          summary: "Per-source execution wrapper with error isolation"
          description: >
            Wrap each source processing in try/except; collect per-source stats; ensure exceptions
            are logged and processing continues with the next source.
          dependencies: ["task 30"]
          completed: false
        - id: "task 32"
          summary: "Deterministic cursor advancement rules"
          description: >
            Advance cursor only after a message is fully processed (matched evaluation + forward/copy attempt).
            Update last_message_id/last_timestamp to the highest successfully processed message to prevent reprocessing.
          dependencies: ["task 31"]
          completed: false
        - id: "task 33"
          summary: "Atomic persistence of updated cursors"
          description: >
            Persist cursor updates back into the YAML config using the atomic write mechanism.
            Ensure partial progress is not lost and does not corrupt the config file on interruption/crash.
          dependencies: ["task 32"]
          completed: false

    - id: "task 34"
      summary: "Rate limit handling and bounded retries"
      description: >
        Implement handling for Telegram API rate limits and transient failures with backoff and bounded retries,
        without risking infinite loops or blocking all sources (NFR-2).
      dependencies: ["task 33"]
      completed: false
      subtasks:
        - id: "task 35"
          summary: "Detect rate-limit signals and backoff"
          description: >
            Identify library exceptions/return codes that indicate flood wait or rate limiting.
            Implement sleep/backoff according to server-provided wait time when available.
          dependencies: ["task 34"]
          completed: false
        - id: "task 36"
          summary: "Bounded retry policy for transient failures"
          description: >
            Implement a small retry budget per operation (fetch/forward/copy), with exponential backoff caps.
            On repeated failure, log and continue to next message/source as appropriate.
          dependencies: ["task 35"]
          completed: false

    - id: "task 37"
      summary: "Structured logging and metrics"
      description: >
        Add structured logging with configurable levels. Log start/end of runs, per-source counts
        (scanned, matched, forwarded), and errors with sufficient context while avoiding secrets (NFR-10, NFR-6).
      dependencies: ["task 36"]
      completed: false
      subtasks:
        - id: "task 38"
          summary: "Implement logging configuration and formatting"
          description: >
            Provide a consistent log format (structured fields or predictable key=value) and support --log-level.
            Ensure logs never print TELEGRAM_API_HASH, session strings, or other sensitive payloads.
          dependencies: ["task 37"]
          completed: false
        - id: "task 39"
          summary: "Per-source counters and run summary"
          description: >
            Track and log per-source stats: messages scanned, matches, forwards succeeded, copy fallbacks,
            and failures. Emit a final summary at run end.
          dependencies: ["task 38"]
          completed: false

    - id: "task 40"
      summary: "Security and file-system hygiene"
      description: >
        Ensure config and session files default to the user’s home directory, recommend restrictive permissions,
        and avoid accidental credential leakage in output (NFR-6, NFR-7).
      dependencies: ["task 39"]
      completed: false
      subtasks:
        - id: "task 41"
          summary: "Harden file permissions recommendations"
          description: >
            Document and (where feasible) enforce restrictive permissions for config/session files.
            Ensure temp files used for atomic writes are created safely in the same directory.
          dependencies: ["task 40"]
          completed: false

    - id: "task 42"
      summary: "Runner script for zero-hassle local execution"
      description: >
        Provide a runner script that creates/uses a virtual environment, installs dependencies if needed,
        runs the CLI, and exits cleanly without requiring the user to manage activation/deactivation manually.
      dependencies: ["task 41"]
      completed: false
      subtasks:
        - id: "task 43"
          summary: "Implement macOS-friendly runner script"
          description: >
            Create a script (e.g., run.sh) that: creates .venv if missing, upgrades pip,
            installs the package (editable or wheel), executes the CLI with passed arguments,
            and returns the CLI exit code. Avoid leaving the user in an activated shell environment.
          dependencies: ["task 42"]
          completed: false
        - id: "task 44"
          summary: "Document one-line usage examples"
          description: >
            Provide concise examples for list-chats and run, including optional --config and --log-level usage,
            and explain where session/config files are stored by default.
          dependencies: ["task 43"]
          completed: false

    - id: "task 45"
      summary: "Testing and validation against requirements"
      description: >
        Validate correctness, idempotency, and resilience: confirm first-run 24h behavior, cursor persistence,
        topic filtering, forwarding fallback behavior, and per-source isolation. Add lightweight automated tests
        where feasible and a manual test checklist for real Telegram environments.
      dependencies: ["task 44"]
      completed: false
      subtasks:
        - id: "task 46"
          summary: "Unit tests for matcher, cursor logic, and atomic write"
          description: >
            Add tests for case-insensitive substring matching, keyword de-duplication, message field extraction,
            cursor advancement rules, and atomic write (temp + rename) behavior.
          dependencies: ["task 45"]
          completed: false
        - id: "task 47"
          summary: "Manual integration test checklist (real account)"
          description: >
            Verify list-chats output, run mode processing for each chat type, topic_id filtering,
            forwarding restrictions handling, rate-limit backoff behavior, and safe stop/re-run idempotency.
          dependencies: ["task 46"]
          completed: false